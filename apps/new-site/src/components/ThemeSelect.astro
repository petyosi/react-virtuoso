---
/**
 * Custom theme switcher that cycles through auto/dark/light with a single button
 */

import { Half2Icon, MoonIcon, SunIcon } from '@radix-ui/react-icons'
---

<starlight-theme-select>
  <button aria-label={Astro.locals.t('themeSelect.accessibleLabel')} class="sl-flex theme-toggle [&>svg]:size-radix-icon" type="button">
    <Half2Icon className="icon-auto" data-theme-icon />
    <MoonIcon className="icon-dark" data-theme-icon />
    <SunIcon className="icon-light" data-theme-icon />
  </button>
</starlight-theme-select>

<script is:inline>
  StarlightThemeProvider.updatePickers()
</script>

<script>
  type Theme = 'auto' | 'dark' | 'light'
  const storageKey = 'starlight-theme'
  const themeOrder: Theme[] = ['auto', 'dark', 'light']

  const parseTheme = (theme: unknown): Theme => (theme === 'auto' || theme === 'dark' || theme === 'light' ? theme : 'auto')

  const loadTheme = (): Theme => parseTheme(typeof localStorage !== 'undefined' && localStorage.getItem(storageKey))

  function storeTheme(theme: Theme): void {
    if (typeof localStorage !== 'undefined') {
      localStorage.setItem(storageKey, theme === 'light' || theme === 'dark' ? theme : '')
    }
  }

  const getPreferredColorScheme = (): Theme => (matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark')

  function updateIcons(theme: Theme): void {
    document.querySelectorAll('starlight-theme-select').forEach((picker) => {
      picker.querySelectorAll('[data-theme-icon]').forEach((icon) => {
        ;(icon as HTMLElement).style.display = 'none'
      })
      const activeIcon = picker.querySelector(`.icon-${theme}`)
      if (activeIcon) {
        ;(activeIcon as HTMLElement).style.display = 'block'
      }
    })
  }

  function onThemeChange(theme: Theme): void {
    document.documentElement.dataset.theme = theme === 'auto' ? getPreferredColorScheme() : theme
    storeTheme(theme)
    updateIcons(theme)
  }

  function cycleTheme(currentTheme: Theme): Theme {
    const currentIndex = themeOrder.indexOf(currentTheme)
    const nextIndex = (currentIndex + 1) % themeOrder.length
    return themeOrder[nextIndex]
  }

  matchMedia('(prefers-color-scheme: light)').addEventListener('change', () => {
    if (loadTheme() === 'auto') onThemeChange('auto')
  })

  class StarlightThemeSelect extends HTMLElement {
    constructor() {
      super()
      onThemeChange(loadTheme())
      this.querySelector('button')?.addEventListener('click', () => {
        const currentTheme = loadTheme()
        const nextTheme = cycleTheme(currentTheme)
        onThemeChange(nextTheme)
      })
    }
  }
  customElements.define('starlight-theme-select', StarlightThemeSelect)
</script>

<style>
  .theme-toggle {
    align-items: center;
    justify-content: center;
    background: transparent;
    border: 0;
    padding: 0.5rem;
    cursor: pointer;
    color: var(--sl-color-gray-1);
    border-radius: 0.5rem;
  }

  .theme-toggle:hover {
    background: var(--sl-color-gray-6);
  }

  .icon {
    display: none;
    width: 1rem;
    height: 1rem;
  }

  .icon-auto {
    display: block;
  }
</style>
